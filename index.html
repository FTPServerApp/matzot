<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול עסק הדפסות תלת מימד</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.rtl.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #1abc9c;
            --bg-light: #f8f9fa;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-accent: #16a085;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            padding-top: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1300px;
        }
        
        .card {
            margin-bottom: 20px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
            border: none;
            border-radius: 12px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.15);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
            border-top-left-radius: 12px !important;
            border-top-right-radius: 12px !important;
            padding: 15px 20px;
        }
        
        .tab-content {
            padding: 25px 0;
        }
        
        .status-pending {
            background-color: #fff3cd;
        }
        
        .status-printing {
            background-color: #d1ecf1;
        }
        
        .status-completed {
            background-color: #d4edda;
        }
        
        .status-delivered {
            background-color: #c3e6cb;
        }
        
        .status-cancelled {
            background-color: #f8d7da;
        }
        
        .printer-active {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .printer-maintenance {
            color: var(--warning-color);
            font-weight: bold;
        }
        
        .printer-inactive {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .low-stock {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .english-text {
            direction: ltr;
            display: inline-block;
        }
        
        .main-title {
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 700;
            position: relative;
            padding-bottom: 10px;
        }
        
        .main-title:after {
            content: '';
            position: absolute;
            width: 80px;
            height: 3px;
            background-color: var(--accent-color);
            bottom: 0;
            right: 0;
        }
        
        .nav-tabs {
            border-bottom: none;
            margin-bottom: 20px;
        }
        
        .nav-tabs .nav-link {
            color: var(--primary-color);
            font-weight: 600;
            border: none;
            border-radius: 8px;
            margin-left: 5px;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        
        .nav-tabs .nav-link:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: transparent;
        }
        
        .nav-tabs .nav-link.active {
            color: white;
            background-color: var(--secondary-color);
            border-color: transparent;
        }
        
        .btn-primary {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        .btn-primary:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        
        .btn-success:hover {
            background-color: var(--dark-accent);
            border-color: var(--dark-accent);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
        }
        
        .table thead {
            background-color: var(--primary-color);
            color: white;
        }
        
        .table thead th {
            border-bottom: none;
            font-weight: 600;
        }
        
        .badge {
            font-size: 85%;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 6px;
        }
        
        .badge-pending {
            background-color: #ffeeba;
            color: #856404;
        }
        
        .badge-printing {
            background-color: #bee5eb;
            color: #0c5460;
        }
        
        .badge-completed {
            background-color: #c3e6cb;
            color: #155724;
        }
        
        .badge-delivered {
            background-color: #9fcdff;
            color: #004085;
        }
        
        .badge-cancelled {
            background-color: #f5c6cb;
            color: #721c24;
        }
        
        .action-buttons .btn {
            margin-right: 5px;
            border-radius: 6px;
            padding: 5px 10px;
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        
        .modal-header {
            background-color: var(--primary-color);
            color: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 15px 20px;
        }
        
        .modal-footer {
            border-top: none;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ced4da;
            transition: border-color 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .dashboard-stat-card {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            text-align: center;
        }
        
        .dashboard-stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }
        
        .dashboard-stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .dashboard-stat-card .stat-label {
            font-size: 1rem;
            color: #6c757d;
        }
        
        .list-group-item {
            border-radius: 8px;
            margin-bottom: 5px;
            border: 1px solid rgba(0,0,0,.125);
        }
        
        /* Responsive adjustments */
        @media (max-width: 992px) {
            .card-body {
                padding: 15px;
            }
            
            .nav-tabs .nav-link {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 768px) {
            .action-buttons .btn {
                margin-bottom: 5px;
                display: block;
                width: 100%;
            }
            
            .dashboard-stat-card {
                margin-bottom: 15px;
            }
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary-color);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* Order status badges */
        .status-badge {
            padding: 8px 12px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
        }
        
        .status-badge-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge-printing {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-badge-completed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge-delivered {
            background-color: #c3e6cb;
            color: #155724;
        }
        
        .status-badge-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Progress indicators */
        .progress {
            height: 0.5rem;
            border-radius: 0.5rem;
            margin-top: 8px;
        }
        
        /* Category chips */
        .category-chip {
            display: inline-block;
            padding: 5px 10px;
            background-color: #e9ecef;
            border-radius: 30px;
            font-size: 0.85rem;
            margin-right: 5px;
            margin-bottom: 5px;
            color: #495057;
        }
        
        /* Icons in tables */
        .table-icon {
            font-size: 1.2rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center main-title animate__animated animate__fadeIn">מערכת ניהול עסק הדפסות תלת מימד</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                    <i class="fas fa-tachometer-alt me-2"></i>לוח בקרה
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="printers-tab" data-bs-toggle="tab" data-bs-target="#printers" type="button" role="tab">
                    <i class="fas fa-print me-2"></i>מדפסות
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab">
                    <i class="fas fa-boxes me-2"></i>מלאי
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="orders-tab" data-bs-toggle="tab" data-bs-target="#orders" type="button" role="tab">
                    <i class="fas fa-shopping-cart me-2"></i>הזמנות
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                    <i class="fas fa-cog me-2"></i>הגדרות
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Dashboard Tab -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <div class="card h-100">
                            <div class="dashboard-stat-card">
                                <i class="fas fa-clock"></i>
                                <div class="stat-value" id="pending-count">0</div>
                                <div class="stat-label">הזמנות בהמתנה</div>
                                <div class="progress w-100">
                                    <div class="progress-bar bg-warning" id="pending-progress" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card h-100">
                            <div class="dashboard-stat-card">
                                <i class="fas fa-spinner"></i>
                                <div class="stat-value" id="printing-count">0</div>
                                <div class="stat-label">הזמנות בהדפסה</div>
                                <div class="progress w-100">
                                    <div class="progress-bar bg-info" id="printing-progress" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card h-100">
                            <div class="dashboard-stat-card">
                                <i class="fas fa-check-circle"></i>
                                <div class="stat-value" id="completed-count">0</div>
                                <div class="stat-label">הזמנות שהושלמו</div>
                                <div class="progress w-100">
                                    <div class="progress-bar bg-success" id="completed-progress" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card h-100">
                            <div class="dashboard-stat-card">
                                <i class="fas fa-truck"></i>
                                <div class="stat-value" id="delivered-count">0</div>
                                <div class="stat-label">הזמנות שנמסרו</div>
                                <div class="progress w-100">
                                    <div class="progress-bar bg-primary" id="delivered-progress" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="fas fa-print me-2"></i>מצב מדפסות
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-around mb-4">
                                    <div class="text-center">
                                        <div class="stat-value printer-active" id="active-printers">0</div>
                                        <div>פעילות</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="stat-value printer-maintenance" id="maintenance-printers">0</div>
                                        <div>בתחזוקה</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="stat-value printer-inactive" id="inactive-printers">0</div>
                                        <div>לא פעילות</div>
                                    </div>
                                </div>
                                <div id="printers-chart" style="height: 250px;">
                                    <!-- Will be populated by chart -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="fas fa-exclamation-triangle me-2"></i>מלאי נמוך
                            </div>
                            <div class="card-body">
                                <ul id="low-stock-items" class="list-group">
                                    <!-- Low stock items will be populated here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-clipboard-list me-2"></i>הזמנות אחרונות
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>מספר הזמנה</th>
                                                <th>לקוח</th>
                                                <th>טלפון</th>
                                                <th>תאריך</th>
                                                <th>סטטוס</th>
                                                <th>פריטים</th>
                                                <th>פעולות</th>
                                            </tr>
                                        </thead>
                                        <tbody id="recent-orders">
                                            <!-- Recent orders will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Printers Tab -->
            <div class="tab-pane fade" id="printers" role="tabpanel">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h3><i class="fas fa-print me-2"></i>ניהול מדפסות</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPrinterModal">
                        <i class="fas fa-plus me-2"></i>הוסף מדפסת חדשה
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>מזהה</th>
                                        <th>שם מדפסת</th>
                                        <th>דגם</th>
                                        <th>סטטוס</th>
                                        <th>שימוש אחרון</th>
                                        <th>פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="printers-list">
                                    <!-- Printers will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Tab -->
            <div class="tab-pane fade" id="inventory" role="tabpanel">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h3><i class="fas fa-boxes me-2"></i>ניהול מלאי</h3>
                    <div>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInventoryModal">
                            <i class="fas fa-plus me-2"></i>הוסף פריט חדש
                        </button>
                        <button class="btn btn-success ms-2" id="exportInventory">
                            <i class="fas fa-file-export me-2"></i>ייצא מלאי
                        </button>
                        <button class="btn btn-warning ms-2" data-bs-toggle="modal" data-bs-target="#importInventoryModal">
                            <i class="fas fa-file-import me-2"></i>ייבא מלאי
                        </button>
                    </div>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-filter me-2"></i>סינון וחיפוש
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label for="inventoryCategoryFilter" class="form-label">סינון לפי קטגוריה:</label>
                                <select class="form-select" id="inventoryCategoryFilter">
                                    <option value="all">כל הקטגוריות</option>
                                    <!-- Categories will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="inventoryStockFilter" class="form-label">סינון לפי מלאי:</label>
                                <select class="form-select" id="inventoryStockFilter">
                                    <option value="all">הכל</option>
                                    <option value="low">מלאי נמוך</option>
                                    <option value="normal">מלאי תקין</option>
                                    <option value="outOfStock">אזל מהמלאי</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-2">
                                <label for="inventorySearch" class="form-label">חיפוש:</label>
                                <input type="text" class="form-control" id="inventorySearch" placeholder="חפש לפי שם או מזהה...">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>מזהה</th>
                                        <th>שם פריט (אנגלית)</th>
                                        <th>קטגוריה</th>
                                        <th>כמות במלאי</th>
                                        <th>מחיר</th>
                                        <th>מינימום במלאי</th>
                                        <th>פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-list">
                                    <!-- Inventory items will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Orders Tab -->
            <div class="tab-pane fade" id="orders" role="tabpanel">
                <div class="d-flex justify-content-between mb-3 align-items-center">
                    <h3><i class="fas fa-shopping-cart me-2"></i>ניהול הזמנות</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOrderModal">
                        <i class="fas fa-plus me-2"></i>הוסף הזמנה חדשה
                    </button>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-filter me-2"></i>סינון וחיפוש
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-2">
                                <label for="orderStatusFilter" class="form-label">סינון לפי סטטוס:</label>
                                <select class="form-select" id="orderStatusFilter">
                                    <option value="all">הכל</option>
                                    <option value="pending">בהמתנה</option>
                                    <option value="printing">בהדפסה</option>
                                    <option value="completed">הושלם</option>
                                    <option value="delivered">נמסר</option>
                                    <option value="cancelled">בוטל</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="orderDateFrom" class="form-label">מתאריך:</label>
                                <input type="date" class="form-control" id="orderDateFrom">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="orderDateTo" class="form-label">עד תאריך:</label>
                                <input type="date" class="form-control" id="orderDateTo">
                            </div>
                            <div class="col-md-3 mb-2">
                                <label for="orderSearch" class="form-label">חיפוש:</label>
                                <input type="text" class="form-control" id="orderSearch" placeholder="חפש לפי שם לקוח או טלפון...">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>מספר הזמנה</th>
                                        <th>לקוח</th>
                                        <th>טלפון</th>
                                        <th>תאריך</th>
                                        <th>סטטוס</th>
                                        <th>סכום</th>
                                        <th>פריטים</th>
                                        <th>פעולות</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-list">
                                    <!-- Orders will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="fas fa-save me-2"></i>גיבוי ושחזור
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <button class="btn btn-primary" id="exportAllData">
                                        <i class="fas fa-download me-2"></i>ייצא את כל הנתונים
                                    </button>
                                    <p class="small text-muted mt-2">ייצוא של כל הנתונים (מדפסות, מלאי והזמנות) לקובץ JSON אחד</p>
                                </div>
                                <div class="mb-3">
                                    <label for="importDataFile" class="form-label">ייבא נתונים מקובץ</label>
                                    <div class="input-group">
                                        <input class="form-control" type="file" id="importDataFile" accept=".json">
                                        <button class="btn btn-warning" id="importAllData">
                                            <i class="fas fa-upload me-1"></i>ייבא
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="fas fa-sync me-2"></i>הגדרות סנכרון
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="syncFrequency" class="form-label">תדירות סנכרון עם אפליקציית אנדרואיד</label>
                                    <select class="form-select" id="syncFrequency">
                                        <option value="manual">ידני בלבד</option>
                                        <option value="hourly">כל שעה</option>
                                        <option value="daily">יומי</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <button class="btn btn-primary" id="syncNow">
                                        <i class="fas fa-sync-alt me-2"></i>סנכרן עכשיו
                                    </button>
                                    <span class="ms-2 badge bg-secondary" id="lastSyncTime">עדיין לא סונכרן</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-sliders-h me-2"></i>הגדרות מערכת
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="systemLanguage" class="form-label">שפת מערכת</label>
                                        <select class="form-select" id="systemLanguage">
                                            <option value="he" selected>עברית</option>
                                            <option value="en">English</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="currency" class="form-label">מטבע</label>
                                        <select class="form-select" id="currency">
                                            <option value="ILS" selected>₪ - שקל</option>
                                            <option value="USD">$ - דולר</option>
                                            <option value="EUR">€ - אירו</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <button class="btn btn-success" id="saveSettings">
                                            <i class="fas fa-save me-2"></i>שמור הגדרות
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Add Printer Modal -->
    <div class="modal fade" id="addPrinterModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-print me-2"></i>הוסף מדפסת חדשה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addPrinterForm">
                        <div class="mb-3">
                            <label for="printerName" class="form-label">שם מדפסת</label>
                            <input type="text" class="form-control" id="printerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="printerModel" class="form-label">דגם</label>
                            <input type="text" class="form-control" id="printerModel" required>
                        </div>
                        <div class="mb-3">
                            <label for="printerSerialNumber" class="form-label">מספר סידורי</label>
                            <input type="text" class="form-control" id="printerSerialNumber">
                        </div>
                        <div class="mb-3">
                            <label for="printerStatus" class="form-label">סטטוס</label>
                            <select class="form-select" id="printerStatus">
                                <option value="active">פעיל</option>
                                <option value="maintenance">בתחזוקה</option>
                                <option value="inactive">לא פעיל</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="printerNotes" class="form-label">הערות</label>
                            <textarea class="form-control" id="printerNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary" id="savePrinterBtn">שמור</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Inventory Modal -->
    <div class="modal fade" id="addInventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-box me-2"></i>הוסף פריט מלאי חדש</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addInventoryForm">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">שם פריט (אנגלית)</label>
                            <input type="text" class="form-control english-text" id="itemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemCategory" class="form-label">קטגוריה</label>
                            <div class="input-group">
                                <select class="form-select" id="itemCategory">
                                    <!-- Categories will be populated dynamically -->
                                </select>
                                <button class="btn btn-outline-secondary" type="button" id="addNewCategoryBtn">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="itemQuantity" class="form-label">כמות במלאי</label>
                            <input type="number" class="form-control" id="itemQuantity" required min="0">
                        </div>
                        <div class="mb-3">
                            <label for="itemPrice" class="form-label">מחיר</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="itemPrice" required min="0" step="0.01">
                                <span class="input-group-text">₪</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="itemMinQuantity" class="form-label">כמות מינימלית (התראה)</label>
                            <input type="number" class="form-control" id="itemMinQuantity" required min="0">
                        </div>
                        <div class="mb-3">
                            <label for="itemDescription" class="form-label">תיאור</label>
                            <textarea class="form-control" id="itemDescription" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary" id="saveInventoryBtn">שמור</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Order Modal -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-shopping-cart me-2"></i>הוסף הזמנה חדשה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addOrderForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerName" class="form-label">שם לקוח</label>
                                <input type="text" class="form-control" id="customerName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerPhone" class="form-label">טלפון</label>
                                <input type="tel" class="form-control" id="customerPhone" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="customerEmail" class="form-label">אימייל</label>
                                <input type="email" class="form-control" id="customerEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="customerAddress" class="form-label">כתובת</label>
                                <input type="text" class="form-control" id="customerAddress">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="orderDate" class="form-label">תאריך</label>
                                <input type="date" class="form-control" id="orderDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="orderStatus" class="form-label">סטטוס</label>
                                <select class="form-select" id="orderStatus">
                                    <option value="pending">בהמתנה</option>
                                    <option value="printing">בהדפסה</option>
                                    <option value="completed">הושלם</option>
                                    <option value="delivered">נמסר</option>
                                    <option value="cancelled">בוטל</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">פריטים</label>
                            <div class="card mb-2">
                                <div class="card-body p-3">
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label small">קטגוריה</label>
                                            <select class="form-select category-select" id="orderCategoryFilter">
                                                <option value="all">כל הקטגוריות</option>
                                                <!-- Categories will be populated dynamically -->
                                            </select>
                                        </div>
                                    </div>
                                    <div id="orderItems">
                                        <div class="order-item row mb-2 border-bottom pb-2">
                                            <div class="col-md-5">
                                                <select class="form-select item-select"></select>
                                            </div>
                                            <div class="col-md-2">
                                                <input type="number" class="form-control item-quantity" placeholder="כמות" min="1" value="1" required>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="input-group">
                                                    <input type="number" class="form-control item-price" placeholder="מחיר" readonly>
                                                    <span class="input-group-text">₪</span>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <button type="button" class="btn btn-outline-danger remove-item">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary mt-2" id="addOrderItemBtn">
                                        <i class="fas fa-plus me-1"></i>הוסף פריט
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="orderNotes" class="form-label">הערות להזמנה</label>
                                <textarea class="form-control" id="orderNotes" rows="2"></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="orderTotal" class="form-label">סה"כ</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="orderTotal" readonly>
                                    <span class="input-group-text">₪</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary" id="saveOrderBtn">שמור</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Inventory Modal -->
    <div class="modal fade" id="importInventoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-file-import me-2"></i>ייבא מלאי מקובץ JSON</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="importInventoryForm">
                        <div class="mb-3">
                            <label for="inventoryFile" class="form-label">בחר קובץ JSON</label>
                            <input class="form-control" type="file" id="inventoryFile" accept=".json">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="importOption" id="mergeOption" value="merge" checked>
                                <label class="form-check-label" for="mergeOption">
                                    מזג עם מלאי קיים
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="importOption" id="replaceOption" value="replace">
                                <label class="form-check-label" for="replaceOption">
                                    החלף מלאי קיים
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary" id="importInventoryBtn">ייבא</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- View Order Modal -->
    <div class="modal fade" id="viewOrderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewOrderTitle"><i class="fas fa-eye me-2"></i>צפייה בהזמנה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="viewOrderBody">
                    <!-- Order details will be populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">סגור</button>
                    <button type="button" class="btn btn-success" id="updateOrderStatusBtn">עדכן סטטוס</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Update Order Status Modal -->
    <div class="modal fade" id="updateStatusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateStatusTitle">עדכון סטטוס הזמנה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">סטטוס חדש</label>
                        <select class="form-select" id="newStatus">
                            <option value="pending">בהמתנה</option>
                            <option value="printing">בהדפסה</option>
                            <option value="completed">הושלם</option>
                            <option value="delivered">נמסר</option>
                            <option value="cancelled">בוטל</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label">הערות לעדכון סטטוס</label>
                        <textarea class="form-control" id="statusNotes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary" id="saveStatusBtn">שמור</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-folder-plus me-2"></i>הוסף קטגוריה חדשה</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newCategoryName" class="form-label">שם הקטגוריה</label>
                        <input type="text" class="form-control" id="newCategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label for="categoryDescription" class="form-label">תיאור</label>
                        <textarea class="form-control" id="categoryDescription" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
                    <button type="button" class="btn btn-primary" id="saveCategoryBtn">שמור</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data structure
        let data = {
            printers: [],
            inventory: [],
            orders: [],
            categories: [],
            settings: {
                syncFrequency: 'manual',
                lastSync: null,
                language: 'he',
                currency: 'ILS'
            }
        };

        // Initialize the application
        $(document).ready(function() {
            // Load data from localStorage if exists
            loadData();
            
            // Update UI
            updateUI();
            
            // Set up event listeners
            setupEventListeners();
        });

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('3dPrinterBusinessData');
            if (savedData) {
                try {
                    data = JSON.parse(savedData);
                    
                    // Ensure categories array exists
                    if (!data.categories) {
                        data.categories = [];
                        
                        // Extract unique categories from inventory if possible
                        const uniqueCategories = [...new Set(data.inventory.map(item => item.category))];
                        data.categories = uniqueCategories.map((cat, index) => ({
                            id: index + 1,
                            name: cat,
                            description: ''
                        }));
                    }
                    
                    // Ensure customer contact info exists for orders
                    data.orders.forEach(order => {
                        if (!order.customerPhone) order.customerPhone = '';
                        if (!order.customerEmail) order.customerEmail = '';
                        if (!order.customerAddress) order.customerAddress = '';
                        if (!order.notes) order.notes = '';
                        if (!order.statusHistory) {
                            order.statusHistory = [{
                                status: order.status,
                                date: order.date,
                                notes: 'סטטוס ראשוני'
                            }];
                        }
                    });
                    
                    // Ensure printers have additional fields
                    data.printers.forEach(printer => {
                        if (!printer.serialNumber) printer.serialNumber = '';
                        if (!printer.notes) printer.notes = '';
                    });
                    
                    // Ensure inventory items have descriptions
                    data.inventory.forEach(item => {
                        if (!item.description) item.description = '';
                    });
                    
                    saveData(); // Save the updated data structure
                } catch (e) {
                    console.error('Error parsing data:', e);
                    // Initialize with some sample data if there's an error
                    initializeSampleData();
                }
            } else {
                // Initialize with some sample data if no data exists
                initializeSampleData();
            }
        }

        // Initialize with sample data
        function initializeSampleData() {
            // Sample categories
            data.categories = [
                { id: 1, name: 'חומרים', description: 'חוטי הדפסה מסוגים שונים' },
                { id: 2, name: 'חלקי חילוף', description: 'חלקי חילוף למדפסות' },
                { id: 3, name: 'אביזרים', description: 'אביזרים שונים להדפסות תלת מימד' }
            ];
            
            // Sample printers
            data.printers = [
                { 
                    id: 1, 
                    name: 'מדפסת 1', 
                    model: 'Prusa i3 MK3S+', 
                    status: 'active', 
                    lastUsed: '2023-05-15',
                    serialNumber: 'PRU12345',
                    notes: 'מדפסת חדשה במצב מצוין'
                },
                { 
                    id: 2, 
                    name: 'מדפסת 2', 
                    model: 'Creality Ender 3', 
                    status: 'maintenance', 
                    lastUsed: '2023-05-10',
                    serialNumber: 'CRE54321',
                    notes: 'יש לבצע תחזוקה שוטפת'
                }
            ];
            
            // Sample inventory
            data.inventory = [
                { 
                    id: 1, 
                    name: 'PLA Filament Black', 
                    category: 'חומרים', 
                    quantity: 5, 
                    price: 89.99, 
                    minQuantity: 2,
                    description: 'חוט PLA שחור באיכות גבוהה, 1.75 מ"מ'
                },
                { 
                    id: 2, 
                    name: 'ABS Filament White', 
                    category: 'חומרים', 
                    quantity: 3, 
                    price: 99.99, 
                    minQuantity: 2,
                    description: 'חוט ABS לבן, 1.75 מ"מ'
                },
                { 
                    id: 3, 
                    name: 'Print Bed Sheet', 
                    category: 'חלקי חילוף', 
                    quantity: 10, 
                    price: 149.99, 
                    minQuantity: 3,
                    description: 'משטח הדפסה חלופי'
                }
            ];
            
            // Sample orders
            data.orders = [
                { 
                    id: 1, 
                    customer: 'ישראל ישראלי', 
                    customerPhone: '050-1234567',
                    customerEmail: 'israel@example.com',
                    customerAddress: 'רחוב הרצל 10, תל אביב',
                    date: '2023-05-14', 
                    status: 'completed', 
                    total: 179.98,
                    notes: 'הלקוח ביקש אריזה מיוחדת',
                    items: [
                        { itemId: 1, quantity: 2, price: 89.99 }
                    ],
                    statusHistory: [
                        { status: 'pending', date: '2023-05-12', notes: 'התקבלה הזמנה חדשה' },
                        { status: 'printing', date: '2023-05-13', notes: 'החלה הדפסה' },
                        { status: 'completed', date: '2023-05-14', notes: 'ההדפסה הסתיימה' }
                    ]
                },
                { 
                    id: 2, 
                    customer: 'שרה כהן', 
                    customerPhone: '052-9876543',
                    customerEmail: 'sarah@example.com',
                    customerAddress: 'רחוב שפירא 5, רעננה',
                    date: '2023-05-16', 
                    status: 'pending', 
                    total: 249.98,
                    notes: 'הלקוחה תגיע לאסוף בעצמה',
                    items: [
                        { itemId: 2, quantity: 1, price: 99.99 },
                        { itemId: 3, quantity: 1, price: 149.99 }
                    ],
                    statusHistory: [
                        { status: 'pending', date: '2023-05-16', notes: 'התקבלה הזמנה חדשה' }
                    ]
                }
            ];
            
            // Default settings
            data.settings = {
                syncFrequency: 'manual',
                lastSync: null,
                language: 'he',
                currency: 'ILS'
            };
            
            saveData();
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('3dPrinterBusinessData', JSON.stringify(data));
        }

        // Update the UI with current data
        function updateUI() {
            updateDashboard();
            updatePrintersList();
            updateInventoryList();
            updateOrdersList();
            updateSettingsUI();
            updateCategoryDropdowns();
        }

        // Update the Dashboard UI
        function updateDashboard() {
            // Update order counts
            const pendingCount = data.orders.filter(order => order.status === 'pending').length;
            const printingCount = data.orders.filter(order => order.status === 'printing').length;
            const completedCount = data.orders.filter(order => order.status === 'completed').length;
            const deliveredCount = data.orders.filter(order => order.status === 'delivered').length;
            const totalOrdersCount = data.orders.length;
            
            $('#pending-count').text(pendingCount);
            $('#printing-count').text(printingCount);
            $('#completed-count').text(completedCount);
            $('#delivered-count').text(deliveredCount);
            
            // Update progress bars
            $('#pending-progress').css('width', totalOrdersCount > 0 ? (pendingCount / totalOrdersCount * 100) + '%' : '0%');
            $('#printing-progress').css('width', totalOrdersCount > 0 ? (printingCount / totalOrdersCount * 100) + '%' : '0%');
            $('#completed-progress').css('width', totalOrdersCount > 0 ? (completedCount / totalOrdersCount * 100) + '%' : '0%');
            $('#delivered-progress').css('width', totalOrdersCount > 0 ? (deliveredCount / totalOrdersCount * 100) + '%' : '0%');
            
            // Update printer status counts
            const activePrinters = data.printers.filter(printer => printer.status === 'active').length;
            const maintenancePrinters = data.printers.filter(printer => printer.status === 'maintenance').length;
            const inactivePrinters = data.printers.filter(printer => printer.status === 'inactive').length;
            
            $('#active-printers').text(activePrinters);
            $('#maintenance-printers').text(maintenancePrinters);
            $('#inactive-printers').text(inactivePrinters);
            
            // Update low stock items
            const lowStockItems = data.inventory.filter(item => item.quantity <= item.minQuantity);
            const $lowStockList = $('#low-stock-items');
            $lowStockList.empty();
            
            if (lowStockItems.length > 0) {
                lowStockItems.forEach(item => {
                    $lowStockList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="english-text">${item.name}</span>
                            <span class="badge bg-danger rounded-pill">${item.quantity}</span>
                        </li>
                    `);
                });
            } else {
                $lowStockList.append('<li class="list-group-item">אין פריטים במלאי נמוך</li>');
            }
            
            // Update recent orders
            const recentOrders = [...data.orders].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            const $recentOrdersList = $('#recent-orders');
            $recentOrdersList.empty();
            
            if (recentOrders.length > 0) {
                recentOrders.forEach(order => {
                    let statusText = '';
                    let statusClass = '';
                    let statusBadge = '';
                    
                    switch(order.status) {
                        case 'pending': 
                            statusText = 'בהמתנה'; 
                            statusClass = 'status-pending';
                            statusBadge = 'status-badge status-badge-pending';
                            break;
                        case 'printing': 
                            statusText = 'בהדפסה'; 
                            statusClass = 'status-printing';
                            statusBadge = 'status-badge status-badge-printing';
                            break;
                        case 'completed': 
                            statusText = 'הושלם'; 
                            statusClass = 'status-completed';
                            statusBadge = 'status-badge status-badge-completed';
                            break;
                        case 'delivered': 
                            statusText = 'נמסר'; 
                            statusClass = 'status-delivered';
                            statusBadge = 'status-badge status-badge-delivered';
                            break;
                        case 'cancelled': 
                            statusText = 'בוטל'; 
                            statusClass = 'status-cancelled';
                            statusBadge = 'status-badge status-badge-cancelled';
                            break;
                    }
                    
                    $recentOrdersList.append(`
                        <tr>
                            <td># ${order.id}</td>
                            <td>${order.customer}</td>
                            <td>${order.customerPhone || '-'}</td>
                            <td>${formatDate(order.date)}</td>
                            <td><span class="${statusBadge}">${statusText}</span></td>
                            <td>${order.items.length}</td>
                            <td>
                                <button class="btn btn-sm btn-primary view-order" data-id="${order.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                $recentOrdersList.append('<tr><td colspan="7" class="text-center">אין הזמנות אחרונות</td></tr>');
            }
        }

        // Update the Printers list
        function updatePrintersList() {
            const $printersList = $('#printers-list');
            $printersList.empty();
            
            if (data.printers.length > 0) {
                data.printers.forEach(printer => {
                    let statusClass = '';
                    let statusText = '';
                    let statusIcon = '';
                    
                    switch(printer.status) {
                        case 'active': 
                            statusClass = 'printer-active'; 
                            statusText = 'פעיל';
                            statusIcon = '<i class="fas fa-check-circle"></i>';
                            break;
                        case 'maintenance': 
                            statusClass = 'printer-maintenance'; 
                            statusText = 'בתחזוקה';
                            statusIcon = '<i class="fas fa-tools"></i>';
                            break;
                        case 'inactive': 
                            statusClass = 'printer-inactive'; 
                            statusText = 'לא פעיל';
                            statusIcon = '<i class="fas fa-times-circle"></i>';
                            break;
                    }
                    
                    $printersList.append(`
                        <tr>
                            <td>${printer.id}</td>
                            <td>${printer.name}</td>
                            <td>${printer.model}</td>
                            <td class="${statusClass}">${statusIcon} ${statusText}</td>
                            <td>${formatDate(printer.lastUsed)}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-printer" data-id="${printer.id}">
                                    <i class="fas fa-edit"></i> ערוך
                                </button>
                                <button class="btn btn-sm btn-danger delete-printer" data-id="${printer.id}">
                                    <i class="fas fa-trash"></i> מחק
                                </button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                $printersList.append('<tr><td colspan="6" class="text-center">אין מדפסות</td></tr>');
            }
        }

        // Update the Inventory list
        function updateInventoryList() {
            const $inventoryList = $('#inventory-list');
            $inventoryList.empty();
            
            // Get filter values
            const categoryFilter = $('#inventoryCategoryFilter').val();
            const stockFilter = $('#inventoryStockFilter').val();
            const searchText = $('#inventorySearch').val().toLowerCase();
            
            // Filter inventory items
            let filteredInventory = [...data.inventory];
            
            if (categoryFilter !== 'all') {
                filteredInventory = filteredInventory.filter(item => item.category === categoryFilter);
            }
            
            if (stockFilter !== 'all') {
                switch(stockFilter) {
                    case 'low':
                        filteredInventory = filteredInventory.filter(item => item.quantity <= item.minQuantity && item.quantity > 0);
                        break;
                    case 'normal':
                        filteredInventory = filteredInventory.filter(item => item.quantity > item.minQuantity);
                        break;
                    case 'outOfStock':
                        filteredInventory = filteredInventory.filter(item => item.quantity === 0);
                        break;
                }
            }
            
            if (searchText) {
                filteredInventory = filteredInventory.filter(item => 
                    item.name.toLowerCase().includes(searchText) || 
                    item.id.toString().includes(searchText) ||
                    item.category.toLowerCase().includes(searchText)
                );
            }
            
            if (filteredInventory.length > 0) {
                filteredInventory.forEach(item => {
                    const lowStockClass = item.quantity <= item.minQuantity ? 'low-stock' : '';
                    
                    $inventoryList.append(`
                        <tr>
                            <td>${item.id}</td>
                            <td><span class="english-text">${item.name}</span></td>
                            <td>${item.category}</td>
                            <td class="${lowStockClass}">${item.quantity}</td>
                            <td>₪${item.price.toFixed(2)}</td>
                            <td>${item.minQuantity}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary edit-inventory" data-id="${item.id}">
                                    <i class="fas fa-edit"></i> ערוך
                                </button>
                                <button class="btn btn-sm btn-danger delete-inventory" data-id="${item.id}">
                                    <i class="fas fa-trash"></i> מחק
                                </button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                $inventoryList.append('<tr><td colspan="7" class="text-center">אין פריטים במלאי התואמים לסינון</td></tr>');
            }
        }

        // Update the Orders list
        function updateOrdersList() {
            const $ordersList = $('#orders-list');
            $ordersList.empty();
            
            // Get filter values
            const statusFilter = $('#orderStatusFilter').val();
            const dateFrom = $('#orderDateFrom').val();
            const dateTo = $('#orderDateTo').val();
            const searchText = $('#orderSearch').val().toLowerCase();
            
            // Filter orders
            let filteredOrders = [...data.orders];
            
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.status === statusFilter);
            }
            
            if (dateFrom) {
                filteredOrders = filteredOrders.filter(order => new Date(order.date) >= new Date(dateFrom));
            }
            
            if (dateTo) {
                filteredOrders = filteredOrders.filter(order => new Date(order.date) <= new Date(dateTo));
            }
            
            if (searchText) {
                filteredOrders = filteredOrders.filter(order => 
                    order.customer.toLowerCase().includes(searchText) || 
                    (order.customerPhone && order.customerPhone.includes(searchText)) ||
                    (order.customerEmail && order.customerEmail.toLowerCase().includes(searchText))
                );
            }
            
            // Sort orders by date (newest first)
            filteredOrders.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredOrders.length > 0) {
                filteredOrders.forEach(order => {
                    let statusText = '';
                    let statusClass = '';
                    let statusBadge = '';
                    
                    switch(order.status) {
                        case 'pending': 
                            statusText = 'בהמתנה'; 
                            statusClass = 'status-pending';
                            statusBadge = 'status-badge status-badge-pending';
                            break;
                        case 'printing': 
                            statusText = 'בהדפסה'; 
                            statusClass = 'status-printing';
                            statusBadge = 'status-badge status-badge-printing';
                            break;
                        case 'completed': 
                            statusText = 'הושלם'; 
                            statusClass = 'status-completed';
                            statusBadge = 'status-badge status-badge-completed';
                            break;
                        case 'delivered': 
                            statusText = 'נמסר'; 
                            statusClass = 'status-delivered';
                            statusBadge = 'status-badge status-badge-delivered';
                            break;
                        case 'cancelled': 
                            statusText = 'בוטל'; 
                            statusClass = 'status-cancelled';
                            statusBadge = 'status-badge status-badge-cancelled';
                            break;
                    }
                    
                    $ordersList.append(`
                        <tr>
                            <td># ${order.id}</td>
                            <td>${order.customer}</td>
                            <td>${order.customerPhone || '-'}</td>
                            <td>${formatDate(order.date)}</td>
                            <td><span class="${statusBadge}">${statusText}</span></td>
                            <td>₪${order.total.toFixed(2)}</td>
                            <td>${order.items.length}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary view-order" data-id="${order.id}">
                                    <i class="fas fa-eye"></i> צפה
                                </button>
                                <button class="btn btn-sm btn-success update-status" data-id="${order.id}">
                                    <i class="fas fa-exchange-alt"></i> עדכן סטטוס
                                </button>
                            </td>
                        </tr>
                    `);
                });
            } else {
                $ordersList.append('<tr><td colspan="8" class="text-center">אין הזמנות התואמות לסינון</td></tr>');
            }
        }

        // Update settings UI
        function updateSettingsUI() {
            $('#syncFrequency').val(data.settings.syncFrequency);
            $('#systemLanguage').val(data.settings.language);
            $('#currency').val(data.settings.currency);
            
            if (data.settings.lastSync) {
                $('#lastSyncTime').text(`סונכרן לאחרונה: ${formatDateTime(data.settings.lastSync)}`);
                $('#lastSyncTime').removeClass('bg-secondary').addClass('bg-success');
            } else {
                $('#lastSyncTime').text('עדיין לא סונכרן');
                $('#lastSyncTime').removeClass('bg-success').addClass('bg-secondary');
            }
        }

        // Update Category Dropdowns
        function updateCategoryDropdowns() {
            // Update inventory category filter
            const $inventoryCategoryFilter = $('#inventoryCategoryFilter');
            $inventoryCategoryFilter.find('option:not(:first)').remove();
            
            // Update item category dropdown
            const $itemCategory = $('#itemCategory');
            $itemCategory.empty();
            
            // Update order category filter
            const $orderCategoryFilter = $('#orderCategoryFilter');
            $orderCategoryFilter.find('option:not(:first)').remove();
            
            // Add categories to all dropdowns
            data.categories.forEach(category => {
                $inventoryCategoryFilter.append(`<option value="${category.name}">${category.name}</option>`);
                $itemCategory.append(`<option value="${category.name}">${category.name}</option>`);
                $orderCategoryFilter.append(`<option value="${category.name}">${category.name}</option>`);
            });
        }

        // Helper function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL');
        }

        // Helper function to format date and time
        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            return date.toLocaleString('he-IL');
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Printers tab
            $('#savePrinterBtn').click(savePrinter);
            $(document).on('click', '.edit-printer', editPrinter);
            $(document).on('click', '.delete-printer', deletePrinter);
            
            // Inventory tab
            $('#saveInventoryBtn').click(saveInventory);
            $(document).on('click', '.edit-inventory', editInventory);
            $(document).on('click', '.delete-inventory', deleteInventory);
            $('#exportInventory').click(exportInventory);
            $('#importInventoryBtn').click(importInventory);
            $('#inventoryCategoryFilter, #inventoryStockFilter').change(updateInventoryList);
            $('#inventorySearch').on('input', updateInventoryList);
            $('#addNewCategoryBtn').click(showAddCategoryModal);
            $('#saveCategoryBtn').click(saveCategory);
            
            // Orders tab
            $('#orderStatusFilter').change(updateOrdersList);
            $('#orderDateFrom, #orderDateTo').change(updateOrdersList);
            $('#orderSearch').on('input', updateOrdersList);
            $('#saveOrderBtn').click(saveOrder);
            $('#addOrderItemBtn').click(addOrderItemRow);
            $(document).on('click', '.remove-item', removeOrderItem);
            $(document).on('change', '.item-select, .item-quantity', updateOrderItemPrice);
            $(document).on('click', '.view-order', viewOrder);
            $(document).on('click', '.update-status', updateOrderStatus);
            $('#updateOrderStatusBtn').click(function() {
                const orderId = $(this).data('order-id');
                showUpdateStatusModal(orderId);
            });
            $('#saveStatusBtn').click(saveOrderStatus);
            
            // Category filtering in order
            $('#orderCategoryFilter').change(filterOrderItemsByCategory);
            
            // Settings tab
            $('#exportAllData').click(exportAllData);
            $('#importAllData').click(importAllData);
            $('#syncNow').click(syncNow);
            $('#syncFrequency').change(updateSyncFrequency);
            $('#saveSettings').click(saveSystemSettings);
        }

        // Save printer
        function savePrinter() {
            const printerName = $('#printerName').val();
            const printerModel = $('#printerModel').val();
            const printerStatus = $('#printerStatus').val();
            const printerSerialNumber = $('#printerSerialNumber').val();
            const printerNotes = $('#printerNotes').val();
            
            if (!printerName || !printerModel) {
                alert('נא למלא את כל השדות החובה');
                return;
            }
            
            // Check if we're in edit mode by looking for data-id attribute
            const printerId = $('#savePrinterBtn').data('printer-id');
            
            if (printerId) {
                // Edit existing printer
                const printer = data.printers.find(p => p.id === printerId);
                
                if (printer) {
                    printer.name = printerName;
                    printer.model = printerModel;
                    printer.status = printerStatus;
                    printer.serialNumber = printerSerialNumber;
                    printer.notes = printerNotes;
                }
                
                // Reset button state
                $('#savePrinterBtn').removeData('printer-id');
            } else {
                // Add new printer
                const newPrinter = {
                    id: data.printers.length > 0 ? Math.max(...data.printers.map(p => p.id)) + 1 : 1,
                    name: printerName,
                    model: printerModel,
                    status: printerStatus,
                    lastUsed: new Date().toISOString().split('T')[0],
                    serialNumber: printerSerialNumber,
                    notes: printerNotes
                };
                
                data.printers.push(newPrinter);
            }
            
            saveData();
            updateUI();
            
            $('#addPrinterModal').modal('hide');
            $('#addPrinterForm')[0].reset();
        }

        // Edit printer
        function editPrinter() {
            const printerId = $(this).data('id');
            const printer = data.printers.find(p => p.id === printerId);
            
            if (printer) {
                $('#printerName').val(printer.name);
                $('#printerModel').val(printer.model);
                $('#printerStatus').val(printer.status);
                $('#printerSerialNumber').val(printer.serialNumber || '');
                $('#printerNotes').val(printer.notes || '');
                
                // Set data-id attribute to track edit mode
                $('#savePrinterBtn').data('printer-id', printerId);
                
                $('#addPrinterModal').modal('show');
            }
        }

        // Delete printer
        function deletePrinter() {
            const printerId = $(this).data('id');
            
            if (confirm('האם אתה בטוח שברצונך למחוק את המדפסת?')) {
                data.printers = data.printers.filter(p => p.id !== printerId);
                saveData();
                updateUI();
            }
        }

        // Save inventory item
        function saveInventory() {
            const itemName = $('#itemName').val();
            const itemCategory = $('#itemCategory').val();
            const itemQuantity = parseInt($('#itemQuantity').val(), 10);
            const itemPrice = parseFloat($('#itemPrice').val());
            const itemMinQuantity = parseInt($('#itemMinQuantity').val(), 10);
            const itemDescription = $('#itemDescription').val();
            
            if (!itemName || !itemCategory || isNaN(itemQuantity) || isNaN(itemPrice) || isNaN(itemMinQuantity)) {
                alert('נא למלא את כל השדות בצורה נכונה');
                return;
            }
            
            // Check if we're in edit mode
            const itemId = $('#saveInventoryBtn').data('item-id');
            
            if (itemId) {
                // Edit existing item
                const item = data.inventory.find(i => i.id === itemId);
                
                if (item) {
                    item.name = itemName;
                    item.category = itemCategory;
                    item.quantity = itemQuantity;
                    item.price = itemPrice;
                    item.minQuantity = itemMinQuantity;
                    item.description = itemDescription;
                }
                
                // Reset button state
                $('#saveInventoryBtn').removeData('item-id');
            } else {
                // Add new item
                const newItem = {
                    id: data.inventory.length > 0 ? Math.max(...data.inventory.map(i => i.id)) + 1 : 1,
                    name: itemName,
                    category: itemCategory,
                    quantity: itemQuantity,
                    price: itemPrice,
                    minQuantity: itemMinQuantity,
                    description: itemDescription
                };
                
                data.inventory.push(newItem);
            }
            
            saveData();
            updateUI();
            
            $('#addInventoryModal').modal('hide');
            $('#addInventoryForm')[0].reset();
        }

        // Edit inventory item
        function editInventory() {
            const itemId = $(this).data('id');
            const item = data.inventory.find(i => i.id === itemId);
            
            if (item) {
                $('#itemName').val(item.name);
                $('#itemCategory').val(item.category);
                $('#itemQuantity').val(item.quantity);
                $('#itemPrice').val(item.price);
                $('#itemMinQuantity').val(item.minQuantity);
                $('#itemDescription').val(item.description || '');
                
                // Set data-id attribute to track edit mode
                $('#saveInventoryBtn').data('item-id', itemId);
                
                $('#addInventoryModal').modal('show');
            }
        }

        // Delete inventory item
        function deleteInventory() {
            const itemId = $(this).data('id');
            
            if (confirm('האם אתה בטוח שברצונך למחוק את הפריט?')) {
                data.inventory = data.inventory.filter(i => i.id !== itemId);
                saveData();
                updateUI();
            }
        }

        // Show Add Category Modal
        function showAddCategoryModal() {
            $('#newCategoryName').val('');
            $('#categoryDescription').val('');
            $('#addCategoryModal').modal('show');
        }

        // Save Category
        function saveCategory() {
            const categoryName = $('#newCategoryName').val();
            const categoryDescription = $('#categoryDescription').val();
            
            if (!categoryName) {
                alert('נא להזין שם קטגוריה');
                return;
            }
            
            // Check if category already exists
            const existingCategory = data.categories.find(c => c.name === categoryName);
            
            if (existingCategory) {
                alert('קטגוריה בשם זה כבר קיימת');
                return;
            }
            
            // Add new category
            const newCategory = {
                id: data.categories.length > 0 ? Math.max(...data.categories.map(c => c.id)) + 1 : 1,
                name: categoryName,
                description: categoryDescription
            };
            
            data.categories.push(newCategory);
            saveData();
            updateCategoryDropdowns();
            
            // Update the item category dropdown to show the new category
            $('#itemCategory').val(categoryName);
            
            $('#addCategoryModal').modal('hide');
        }

        // Export inventory to JSON file
        function exportInventory() {
            const inventoryData = JSON.stringify(data.inventory, null, 2);
            const blob = new Blob([inventoryData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventory_export_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Import inventory from JSON file
        function importInventory() {
            const fileInput = document.getElementById('inventoryFile');
            const importOption = $('input[name="importOption"]:checked').val();
            
            if (fileInput.files.length === 0) {
                alert('נא לבחור קובץ');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedData)) {
                        throw new Error('Invalid data format');
                    }
                    
                    if (importOption === 'replace') {
                        data.inventory = importedData;
                    } else {
                        // Merge with existing inventory
                        importedData.forEach(newItem => {
                            const existingItem = data.inventory.find(i => i.name === newItem.name);
                            
                            if (existingItem) {
                                existingItem.quantity += newItem.quantity;
                                existingItem.price = newItem.price;
                                existingItem.category = newItem.category;
                                existingItem.minQuantity = newItem.minQuantity;
                                if (newItem.description) existingItem.description = newItem.description;
                            } else {
                                const newId = data.inventory.length > 0 ? Math.max(...data.inventory.map(i => i.id)) + 1 : 1;
                                data.inventory.push({
                                    ...newItem,
                                    id: newId
                                });
                                
                                // Add category if it doesn't exist
                                if (newItem.category && !data.categories.some(c => c.name === newItem.category)) {
                                    data.categories.push({
                                        id: data.categories.length > 0 ? Math.max(...data.categories.map(c => c.id)) + 1 : 1,
                                        name: newItem.category,
                                        description: ''
                                    });
                                }
                            }
                        });
                    }
                    
                    saveData();
                    updateUI();
                    $('#importInventoryModal').modal('hide');
                    alert('ייבוא הושלם בהצלחה');
                } catch (error) {
                    alert('שגיאה בקריאת הקובץ: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Filter order items by category
        function filterOrderItemsByCategory() {
            const selectedCategory = $(this).val();
            
            $('.item-select').each(function() {
                const $select = $(this);
                $select.empty();
                $select.append('<option value="">-- בחר פריט --</option>');
                
                data.inventory.forEach(item => {
                    if (selectedCategory === 'all' || item.category === selectedCategory) {
                        $select.append(`<option value="${item.id}" data-price="${item.price}">${item.name}</option>`);
                    }
                });
            });
        }

        // Populate order item dropdown with inventory items
        function populateItemDropdown($select, selectedCategory = 'all') {
            $select.empty();
            $select.append('<option value="">-- בחר פריט --</option>');
            
            data.inventory.forEach(item => {
                if (selectedCategory === 'all' || item.category === selectedCategory) {
                    $select.append(`<option value="${item.id}" data-price="${item.price}">${item.name}</option>`);
                }
            });
        }

        // Add new order item row
        function addOrderItemRow() {
            const selectedCategory = $('#orderCategoryFilter').val();
            
            const $newRow = $(`
                <div class="order-item row mb-2 border-bottom pb-2">
                    <div class="col-md-5">
                        <select class="form-select item-select"></select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control item-quantity" placeholder="כמות" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control item-price" placeholder="מחיר" readonly>
                            <span class="input-group-text">₪</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `);
            
            $('#orderItems').append($newRow);
            populateItemDropdown($newRow.find('.item-select'), selectedCategory);
        }

        // Remove order item row
        function removeOrderItem() {
            $(this).closest('.order-item').remove();
            calculateOrderTotal();
        }

        // Update order item price based on selected item and quantity
        function updateOrderItemPrice() {
            const $row = $(this).closest('.order-item');
            const itemId = parseInt($row.find('.item-select').val(), 10);
            const quantity = parseInt($row.find('.item-quantity').val(), 10) || 0;
            
            if (itemId) {
                const item = data.inventory.find(i => i.id === itemId);
                if (item) {
                    const totalPrice = item.price * quantity;
                    $row.find('.item-price').val(totalPrice.toFixed(2));
                }
            } else {
                $row.find('.item-price').val('');
            }
            
            calculateOrderTotal();
        }

        // Calculate order total
        function calculateOrderTotal() {
            let total = 0;
            
            $('.order-item').each(function() {
                const price = parseFloat($(this).find('.item-price').val()) || 0;
                total += price;
            });
            
            $('#orderTotal').val(total.toFixed(2));
        }

        // Save order
        function saveOrder() {
            const customerName = $('#customerName').val();
            const customerPhone = $('#customerPhone').val();
            const customerEmail = $('#customerEmail').val();
            const customerAddress = $('#customerAddress').val();
            const orderDate = $('#orderDate').val();
            const orderStatus = $('#orderStatus').val();
            const orderNotes = $('#orderNotes').val();
            const orderTotal = parseFloat($('#orderTotal').val()) || 0;
            
            if (!customerName || !customerPhone || !orderDate) {
                alert('נא למלא את כל שדות החובה (שם, טלפון ותאריך)');
                return;
            }
            
            const orderItems = [];
            let valid = true;
            
            $('.order-item').each(function() {
                const itemId = parseInt($(this).find('.item-select').val(), 10);
                const quantity = parseInt($(this).find('.item-quantity').val(), 10) || 0;
                const price = parseFloat($(this).find('.item-price').val()) || 0;
                
                if (!itemId || quantity <= 0) {
                    valid = false;
                    return false;
                }
                
                orderItems.push({
                    itemId: itemId,
                    quantity: quantity,
                    price: price / quantity
                });
            });
            
            if (!valid || orderItems.length === 0) {
                alert('נא למלא את כל פרטי הפריטים');
                return;
            }
            
            // Check if we're in edit mode
            const orderId = $('#saveOrderBtn').data('order-id');
            
            if (orderId) {
                // Edit existing order
                const order = data.orders.find(o => o.id === orderId);
                
                if (order) {
                    // Check inventory for added items (comparing old vs new items)
                    const oldItemIds = order.items.map(item => item.itemId);
                    
                    for (const orderItem of orderItems) {
                        const oldItem = order.items.find(item => item.itemId === orderItem.itemId);
                        
                        if (!oldItem) {
                            // New item added to the order
                            const inventoryItem = data.inventory.find(i => i.id === orderItem.itemId);
                            if (inventoryItem && inventoryItem.quantity < orderItem.quantity) {
                                alert(`אין מספיק מלאי עבור ${inventoryItem.name}. נותרו רק ${inventoryItem.quantity} יחידות במלאי.`);
                                return;
                            }
                        } else if (orderItem.quantity > oldItem.quantity) {
                            // Increased quantity of existing item
                            const inventoryItem = data.inventory.find(i => i.id === orderItem.itemId);
                            const additionalQuantity = orderItem.quantity - oldItem.quantity;
                            if (inventoryItem && inventoryItem.quantity < additionalQuantity) {
                                alert(`אין מספיק מלאי עבור ${inventoryItem.name}. נותרו רק ${inventoryItem.quantity} יחידות במלאי.`);
                                return;
                            }
                        }
                    }
                    
                    // Return removed items to inventory
                    for (const oldItem of order.items) {
                        const newItem = orderItems.find(item => item.itemId === oldItem.itemId);
                        
                        if (!newItem) {
                            // Item removed from order, return to inventory
                            const inventoryItem = data.inventory.find(i => i.id === oldItem.itemId);
                            if (inventoryItem) {
                                inventoryItem.quantity += oldItem.quantity;
                            }
                        } else if (newItem.quantity < oldItem.quantity) {
                            // Reduced quantity of item, return difference to inventory
                            const inventoryItem = data.inventory.find(i => i.id === oldItem.itemId);
                            if (inventoryItem) {
                                inventoryItem.quantity += (oldItem.quantity - newItem.quantity);
                            }
                        }
                    }
                    
                    // Deduct new items from inventory
                    for (const orderItem of orderItems) {
                        const oldItem = order.items.find(item => item.itemId === orderItem.itemId);
                        const inventoryItem = data.inventory.find(i => i.id === orderItem.itemId);
                        
                        if (!oldItem) {
                            // New item added to the order
                            if (inventoryItem) {
                                inventoryItem.quantity -= orderItem.quantity;
                            }
                        } else if (orderItem.quantity > oldItem.quantity) {
                            // Increased quantity of existing item
                            if (inventoryItem) {
                                inventoryItem.quantity -= (orderItem.quantity - oldItem.quantity);
                            }
                        }
                    }
                    
                    // Update order
                    order.customer = customerName;
                    order.customerPhone = customerPhone;
                    order.customerEmail = customerEmail;
                    order.customerAddress = customerAddress;
                    order.date = orderDate;
                    order.status = orderStatus;
                    order.notes = orderNotes;
                    order.total = orderTotal;
                    order.items = orderItems;
                    
                    // Add status history if status changed
                    if (order.status !== orderStatus) {
                        order.statusHistory.push({
                            status: orderStatus,
                            date: new Date().toISOString().split('T')[0],
                            notes: 'עדכון סטטוס בעת עריכת הזמנה'
                        });
                    }
                }
                
                // Reset button state
                $('#saveOrderBtn').removeData('order-id');
            } else {
                // Add new order
                
                // Check if we have enough inventory
                for (const orderItem of orderItems) {
                    const inventoryItem = data.inventory.find(i => i.id === orderItem.itemId);
                    if (inventoryItem && inventoryItem.quantity < orderItem.quantity) {
                        alert(`אין מספיק מלאי עבור ${inventoryItem.name}. נותרו רק ${inventoryItem.quantity} יחידות במלאי.`);
                        return;
                    }
                }
                
                // Deduct from inventory
                for (const orderItem of orderItems) {
                    const inventoryItem = data.inventory.find(i => i.id === orderItem.itemId);
                    if (inventoryItem) {
                        inventoryItem.quantity -= orderItem.quantity;
                    }
                }
                
                const newOrder = {
                    id: data.orders.length > 0 ? Math.max(...data.orders.map(o => o.id)) + 1 : 1,
                    customer: customerName,
                    customerPhone: customerPhone,
                    customerEmail: customerEmail,
                    customerAddress: customerAddress,
                    date: orderDate,
                    status: orderStatus,
                    notes: orderNotes,
                    total: orderTotal,
                    items: orderItems,
                    statusHistory: [
                        {
                            status: orderStatus,
                            date: orderDate,
                            notes: 'יצירת הזמנה חדשה'
                        }
                    ]
                };
                
                data.orders.push(newOrder);
            }
            
            saveData();
            updateUI();
            
            $('#addOrderModal').modal('hide');
            $('#addOrderForm')[0].reset();
            resetOrderItemsForm();
        }

        // Reset order items form
        function resetOrderItemsForm() {
            $('#orderItems').html(`
                <div class="order-item row mb-2 border-bottom pb-2">
                    <div class="col-md-5">
                        <select class="form-select item-select"></select>
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control item-quantity" placeholder="כמות" min="1" value="1" required>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" class="form-control item-price" placeholder="מחיר" readonly>
                            <span class="input-group-text">₪</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-danger remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `);
            
            // Reset order category filter
            $('#orderCategoryFilter').val('all');
            
            // Populate item dropdown
            populateItemDropdown($('.item-select').first());
        }

        // View order details
        function viewOrder() {
            const orderId = $(this).data('id');
            const order = data.orders.find(o => o.id === orderId);
            
            if (order) {
                let itemsHtml = '';
                let statusText = '';
                let statusBadge = '';
                
                switch(order.status) {
                    case 'pending': 
                        statusText = 'בהמתנה'; 
                        statusBadge = 'status-badge status-badge-pending';
                        break;
                    case 'printing': 
                        statusText = 'בהדפסה'; 
                        statusBadge = 'status-badge status-badge-printing';
                        break;
                    case 'completed': 
                        statusText = 'הושלם'; 
                        statusBadge = 'status-badge status-badge-completed';
                        break;
                    case 'delivered': 
                        statusText = 'נמסר'; 
                        statusBadge = 'status-badge status-badge-delivered';
                        break;
                    case 'cancelled': 
                        statusText = 'בוטל'; 
                        statusBadge = 'status-badge status-badge-cancelled';
                        break;
                }
                
                // Build items table
                order.items.forEach(item => {
                    const inventoryItem = data.inventory.find(i => i.id === item.itemId) || { name: 'פריט לא קיים' };
                    itemsHtml += `
                        <tr>
                            <td><span class="english-text">${inventoryItem.name}</span></td>
                            <td>${inventoryItem.category || '-'}</td>
                            <td>${item.quantity}</td>
                            <td>₪${item.price.toFixed(2)}</td>
                            <td>₪${(item.price * item.quantity).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                // Build status history
                let statusHistoryHtml = '';
                if (order.statusHistory && order.statusHistory.length > 0) {
                    order.statusHistory.forEach(history => {
                        let historyStatusText = '';
                        let historyStatusBadge = '';
                        
                        switch(history.status) {
                            case 'pending': 
                                historyStatusText = 'בהמתנה'; 
                                historyStatusBadge = 'status-badge status-badge-pending';
                                break;
                            case 'printing': 
                                historyStatusText = 'בהדפסה'; 
                                historyStatusBadge = 'status-badge status-badge-printing';
                                break;
                            case 'completed': 
                                historyStatusText = 'הושלם'; 
                                historyStatusBadge = 'status-badge status-badge-completed';
                                break;
                            case 'delivered': 
                                historyStatusText = 'נמסר'; 
                                historyStatusBadge = 'status-badge status-badge-delivered';
                                break;
                            case 'cancelled': 
                                historyStatusText = 'בוטל'; 
                                historyStatusBadge = 'status-badge status-badge-cancelled';
                                break;
                        }
                        
                        statusHistoryHtml += `
                            <div class="mb-2 pb-2 border-bottom">
                                <div class="d-flex justify-content-between">
                                    <span><span class="${historyStatusBadge}">${historyStatusText}</span></span>
                                    <small class="text-muted">${formatDate(history.date)}</small>
                                </div>
                                <p class="small mt-1 mb-0">${history.notes || '-'}</p>
                            </div>
                        `;
                    });
                }
                
                // Update modal content
                $('#viewOrderTitle').html(`<i class="fas fa-eye me-2"></i>צפייה בהזמנה מספר ${order.id}`);
                $('#viewOrderBody').html(`
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">פרטי לקוח</div>
                                <div class="card-body">
                                    <p><strong>שם:</strong> ${order.customer}</p>
                                    <p><strong>טלפון:</strong> ${order.customerPhone || '-'}</p>
                                    <p><strong>אימייל:</strong> ${order.customerEmail || '-'}</p>
                                    <p><strong>כתובת:</strong> ${order.customerAddress || '-'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">פרטי הזמנה</div>
                                <div class="card-body">
                                    <p><strong>תאריך:</strong> ${formatDate(order.date)}</p>
                                    <p><strong>סטטוס:</strong> <span class="${statusBadge}">${statusText}</span></p>
                                    <p><strong>סה"כ:</strong> ₪${order.total.toFixed(2)}</p>
                                    <p><strong>הערות:</strong> ${order.notes || '-'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card mb-3">
                                <div class="card-header">פריטים</div>
                                <div class="card-body">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>פריט</th>
                                                <th>קטגוריה</th>
                                                <th>כמות</th>
                                                <th>מחיר ליחידה</th>
                                                <th>סה"כ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${itemsHtml}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header">היסטוריית סטטוסים</div>
                                <div class="card-body">
                                    ${statusHistoryHtml || '<p>אין היסטוריית סטטוסים</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                // Set order ID for update status button
                $('#updateOrderStatusBtn').data('order-id', order.id);
                
                // Show modal
                $('#viewOrderModal').modal('show');
            }
        }

        // Update order status
        function updateOrderStatus() {
            const orderId = $(this).data('id');
            showUpdateStatusModal(orderId);
        }

        // Show Update Status Modal
        function showUpdateStatusModal(orderId) {
            const order = data.orders.find(o => o.id === orderId);
            
            if (order) {
                $('#updateStatusTitle').html(`עדכון סטטוס הזמנה מספר ${order.id}`);
                $('#newStatus').val(order.status);
                $('#statusNotes').val('');
                
                // Set order ID for save button
                $('#saveStatusBtn').data('order-id', orderId);
                
                $('#updateStatusModal').modal('show');
            }
        }

        // Save Order Status
        function saveOrderStatus() {
            const orderId = $('#saveStatusBtn').data('order-id');
            const newStatus = $('#newStatus').val();
            const statusNotes = $('#statusNotes').val();
            
            const order = data.orders.find(o => o.id === orderId);
            
            if (order) {
                // Only update if status has changed
                if (order.status !== newStatus) {
                    // Add to status history
                    if (!order.statusHistory) {
                        order.statusHistory = [];
                    }
                    
                    order.statusHistory.push({
                        status: newStatus,
                        date: new Date().toISOString().split('T')[0],
                        notes: statusNotes || 'עדכון סטטוס'
                    });
                    
                    // Update current status
                    order.status = newStatus;
                    
                    saveData();
                    updateUI();
                }
                
                $('#updateStatusModal').modal('hide');
            }
        }

        // Export all data
        function exportAllData() {
            const allData = JSON.stringify(data, null, 2);
            const blob = new Blob([allData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = '3d_printer_business_data_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Import all data
        function importAllData() {
            const fileInput = document.getElementById('importDataFile');
            
            if (fileInput.files.length === 0) {
                alert('נא לבחור קובץ');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.printers || !importedData.inventory || !importedData.orders) {
                        throw new Error('פורמט נתונים לא תקין');
                    }
                    
                    if (confirm('פעולה זו תחליף את כל הנתונים הקיימים. האם להמשיך?')) {
                        // Ensure categories exist
                        if (!importedData.categories) {
                            importedData.categories = [];
                            
                            // Extract unique categories from inventory
                            const uniqueCategories = [...new Set(importedData.inventory.map(item => item.category))];
                            importedData.categories = uniqueCategories.map((cat, index) => ({
                                id: index + 1,
                                name: cat,
                                description: ''
                            }));
                        }
                        
                        // Ensure settings exist
                        if (!importedData.settings) {
                            importedData.settings = {
                                syncFrequency: 'manual',
                                lastSync: null,
                                language: 'he',
                                currency: 'ILS'
                            };
                        }
                        
                        data = importedData;
                        saveData();
                        updateUI();
                        alert('ייבוא הושלם בהצלחה');
                    }
                } catch (error) {
                    alert('שגיאה בקריאת הקובץ: ' + error.message);
                }
            };
            
            reader.readAsText(file);
        }

        // Update sync frequency
        function updateSyncFrequency() {
            data.settings.syncFrequency = $('#syncFrequency').val();
            saveData();
        }

        // Save system settings
        function saveSystemSettings() {
            data.settings.language = $('#systemLanguage').val();
            data.settings.currency = $('#currency').val();
            
            saveData();
            updateUI();
            
            alert('הגדרות נשמרו בהצלחה');
        }

        // Sync now - simulate synchronization with Android app
        function syncNow() {
            // In a real application, this would communicate with an Android app
            // Here we just update the last sync time
            data.settings.lastSync = new Date().toISOString();
            saveData();
            updateSettingsUI();
            alert('סנכרון הושלם בהצלחה');
        }

        // When the page loads, populate the form dropdowns
        $(document).ready(function() {
            // Initialize date inputs with today's date
            const today = new Date().toISOString().split('T')[0];
            $('#orderDate').val(today);
            $('#orderDateFrom').val('');
            $('#orderDateTo').val('');
            
            // Initialize category filters
            updateCategoryDropdowns();
            
            // Populate the first item dropdown
            populateItemDropdown($('.item-select').first());
        });
    </script>
</body>
</html>
                    
            
